{% extends "index.html" %}
{% block content %}
{% with messages = get_flashed_messages() %}
{% if messages %}
    {% for m in messages %}
        <p>{{m}}</p>
    {% endfor %}
{% endif %}
{% endwith %}
{# Each entry will have an assinged id for page section redirect #}
{% set section = namespace(value=0) %}
<div class="form_post">
    {% if session["user_id"] is defined %}
    <button onclick="hideForm()" id="create_post" class="create_post_element">
        Create Post
    </button><br>
    <form action="{{ url_for('create_post') }}" method="POST" enctype="application/x-www-form-urlencoded" id="form_post">
        <input type="text" name="title" placeholder="An intriguing title" maxlength="50" minlength="1" required
        oninvalid="this.setCustomValidity('A title is required')" oninput="this.setCustomValidity('')" class="create_post_element"><br>
        <textarea name="content" cols="30" rows="10" placeholder="Your text (optional)" maxlength="2000"></textarea class="create_post_element"><br>
        <select name="type" required oninvalid="this.setCustomValidity('Select a category')" oninput="this.setCustomValidity('')" class="create_post_element">
            <option value="">--Select Category--</option>
            <option value="General">General</option>
            <option value="Help">Help</option>
            <option value="Lore">Lore</option>
            <option value="Humor">Humor</option>
            <option value="News">News</option>
        </select><br>
        <input type="submit" value="Post" class="create_post_element">
        <input type="hidden" name="user_id" value="{{ session['user_id'] }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    </form>
    {# Shows or hide the form when the user clicks the button
        This button is only visible to logged in users #}
    {% else %}
    <a href="{{ url_for('account', action='sign_in')}}">
        <button style="text-align:center;">Log in to start creating posts</button>
    </a>        
    {% endif %}
</div><br>
{# Sorting #}
<div class="sort">
    <form action="{{ url_for('sort', type='sort') }}" method="POST" enctype="application/x-www-form-urlencoded">
        <select name="type" required>
            {#categories = {
            "1":"general",
            "2":"help",
            "3":"lore",
            "4":"humor",
            "5":"news"} #}
            <option value="">-Find Post By Category--</option>
            <option value="1">General</option>
            <option value="2">Help</option>
            <option value="3">Lore</option>
            <option value="4">Humor</option>
            <option value="5">News</option>
            <option value="">Reset Sort</option>
        </select>
        <input type="submit" value="Sort">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    </form><br>
    <form action="{{ url_for('sort', type='order') }}" method="POST" enctype="application/x-www-form-urlencoded">
        <select name="order" required>
            {# order = {
            "1":"id",
            "2":"like",
            "3":"dislike"} #}
            <option value="">-Order By--</option>
            <option value="1">Likes</option>
            <option value="2">Dislikes</option>
            <option value="">Newest</option>
        </select>
        <input type="submit" value="Order">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    </form>
</div>
<div class="main_page">
    <ul>
        {#
            Reference
            Index : Column Name
                0 : id
                1 : type
                2 : title
                3 : content
                4 : user_id
                5 : date
                6 : dislike
                7 : like
                8 : username
                9 : comment
                10: grade
        #}
        {% for post in post %}
            {% set section.value = section.value + 1 %}
            <li id="{{ section.value }}">
                <a href="{{ url_for('page', id=post[0]) }}">
                    <div class="post">
                        <div class="post_head">
                            {# id, title #}
                            <h4 class="post_title">{{ post[2] }}</h4>
                            {# user_id, username, date #}
                            <p>{{ post[8] }} ‚óè {{ post[5][6:] }} / {{ post[5][4:6] }} / {{ post[5][:4] }} </p>
                            {# type #}
                            <p>{{ post[1] }}</p>
                        </div>
                        <div class="post_body">
                            {# post content #}
                            <p>{{ post[3] }}</p>
                        </div>
                        <!-- likes and dislikes -->
                        <div class="post_foot">
                            {% if post[10] == 1 %}
                                Likes : {{ post[7] }}
                                Dislikes : {{ post[6] }}
                                <form class="grade" action="{{ url_for('grade', id=post[0]) }}" method="POST" enctype="application/x-www-form-urlencoded">
                                    <input type="hidden" name="table" value="p">
                                    <input type="hidden" name="section" value="{{ section.value }}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    Liked
                                    {# Dislike Post #}
                                    <input type="submit" name="grade" value="Dislike">
                                </form>
                            {% elif post[10] == -1 %}
                                Likes : {{ post[7] }}
                                Dislikes : {{ post[6] }}
                                <form class="grade" action="{{ url_for('grade', id=post[0]) }}" method="POST" enctype="application/x-www-form-urlencoded">
                                    <input type="hidden" name="table" value="p">
                                    <input type="hidden" name="section" value="{{ section.value }}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    Disliked
                                    {# Like Post #}
                                    <input type="submit" name="grade" value="Like">
                                </form>
                            {% else %}
                            Likes : {{ post[7] }}
                            Dislikes : {{ post[6] }}
                                <form class="grade" action="{{ url_for('grade', id=post[0]) }}" method="POST" enctype="application/x-www-form-urlencoded">
                                    <input type="hidden" name="table" value="p">
                                    <input type="hidden" name="section" value="{{ section.value }}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    {# likes #}
                                    <input type="submit" name="grade" value="Like">
                                    {# dislikes #}
                                    <input type="submit" name="grade" value="Dislike">
                                </form>
                            {% endif %}
                            Comments : {{ post[9] }}
                        </div>
                    </div>
                </a>
            </li>
        {% endfor %}
    </ul>
</div>
<script>
    var show = document.getElementById("form_post");
    show.style.display = "none"
    function hideForm() {
        if (show.style.display == "none"){
            show.style.display = "block";
        } else {
            show.style.display = "none";
        }
    }
</script>
{% endblock %}